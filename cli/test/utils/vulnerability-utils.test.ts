import { describe, it, expect, vi, beforeEach } from 'vitest';
import { satisfies } from 'semver';

describe('Version Range Matching', () => {
  it('matches npm versions using semver', () => {
    // Test semver matching
    expect(satisfies('4.18.0', '>=4.0.0 <4.18.2')).toBe(true);
    expect(satisfies('4.18.2', '>=4.0.0 <4.18.2')).toBe(false);
    expect(satisfies('3.0.0', '>=4.0.0 <4.18.2')).toBe(false);
  });

  it('handles version ranges', () => {
    expect(satisfies('1.2.3', '>=1.0.0 <2.0.0')).toBe(true);
    expect(satisfies('2.0.0', '>=1.0.0 <2.0.0')).toBe(false);
  });
});

describe('Advisory Merging', () => {
  it('deduplicates advisories by ID', () => {
    const advisories = [
      { id: 'GHSA-123', source: 'ghsa' },
      { id: 'GHSA-123', source: 'osv' }, // Duplicate
      { id: 'GHSA-456', source: 'ghsa' },
    ];

    const seen = new Set<string>();
    const deduped = advisories.filter((adv) => {
      if (seen.has(adv.id)) return false;
      seen.add(adv.id);
      return true;
    });

    expect(deduped).toHaveLength(2);
    expect(deduped.some((a) => a.id === 'GHSA-123')).toBe(true);
    expect(deduped.some((a) => a.id === 'GHSA-456')).toBe(true);
  });

  it('preserves both sources when deduplicating', () => {
    const advisories = [
      { id: 'CVE-2023-123', source: 'ghsa', summary: 'GHSA summary' },
      { id: 'CVE-2023-123', source: 'osv', summary: 'OSV summary' },
    ];

    // In real implementation, we'd merge fields, but for now just dedupe
    const seen = new Set<string>();
    const deduped = advisories.filter((adv) => {
      if (seen.has(adv.id)) return false;
      seen.add(adv.id);
      return true;
    });

    expect(deduped).toHaveLength(1);
  });
});

